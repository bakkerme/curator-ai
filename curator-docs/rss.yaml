workflow:
  name: "Cybersecurity Research"
  # version: "1.0" # optional

  trigger:
    - cron:
        schedule: "0 0 * * *" # midnight UTC
        # timezone: "UTC"     # optional

  sources:
    - rss:
        include_content: true
        user_agent: "curator-ai/0.1"
        feeds:
          - https://www.scrapingbee.com/index.xml
          - https://scrapfly.io/blog/feed.xml
          - https://blog.castle.io/rss/
          - https://fingerprint.com/rss.xml
          - https://unit42.paloaltonetworks.com/feed/
          - https://googleprojectzero.blogspot.com/feeds/posts/default?alt=rss
          - https://openai.com/news/rss.xml
          - https://deepmind.google/blog/rss.xml
          - https://www.silobreaker.com/feed/
          # - https://kameleo.io/blog

  quality:

  post_summary:
    - llm:
        name: post_sum
        type: llm
        context: post
        prompt_template: postSummaryTemplate
        # Enable prompt-level batching (requires batch templates that can render `.Blocks`):
        # batch_size: 5
        # batch_prompt_template: postSummaryTemplateBatch
        params:
          interests:
            - "Threat actor profiles"
        # snapshot:
        #   snapshot: true
        #   restore: true
        #   path: "snapshots/post-summary.json"

    - markdown:
        name: markdown_to_html_post_sum
        type: markdown
        context: post



  run_summary:
    - llm:
        name: full_sum
        type: llm
        context: flow
        prompt_template: fullSummaryTemplate
        params:
          focus:
            - "Active exploitation / emerging campaigns"
            - "High-impact vulnerabilities and exploit techniques"
            - "Actionable defense guidance"
            - "Notable research writeups (root cause + fix)"
        # snapshot:
        #   # snapshot: true
        #   restore: true
        #   path: "snapshots/run-summary.json"
    - markdown:
        name: markdown_to_html_sum
        type: markdown
        context: "flow"


  output:
    - email:
        template: emailTemplate
        to: brandon@bdmd.com.au
        subject: "Daily Security Research"

templates:
  - id: isRelevantTemplate
    system_template: |-
      You are a strict relevance/quality evaluator.

      Evaluate the following post and output ONLY valid JSON with this exact shape:
      {"score": <number 0..1>, "reason": <string>}

      Scoring guidance:
      - 0.0 = completely irrelevant / low-signal
      - 1.0 = extremely relevant / high-signal

      Positive evaluation criteria (score higher when these apply):
      {{- range .Evaluations }}
      - {{ . }}
      {{- end }}

      Exclusion criteria (score near 0 when these apply):
      {{- range .Exclusions }}
      - {{ . }}
      {{- end }}

      Reason should be a single sentence of 25 words or less.

      Return ONLY the JSON object. No markdown, no code fences.
    template: |-
      -----USER CONTENT START-----
      Post:
      Title: {{ .Title }}
      URL: {{ .URL }}
      Author: {{ .Author }}
      CreatedAt: {{ .CreatedAt }}

      Content:
      {{ .Content }}

      Web Content:
      {{- range .WebBlocks }}
      - {{ .URL }}
        {{ .Page }}
      {{- end }}
      -----USER CONTENT END-----

  - id: postSummaryTemplate
    system_template: |-
      You are an expert technical analyst.

      Write a concise summary of the following post. Focus on the reader interests.
      Keep it factual, and include concrete details (numbers, model names, benchmarks) when present.
      When comments are present, summarise the community response.

      Reader interests:
      {{- range (index .Params "interests") }}
      - {{ . }}
      {{- end }}

      Output format:
      - 3-6 bullet points
      - then "Why it matters:" (1-2 sentences)
      - then "Community response:" (1-2 sentences if comments are provided)
      - then "Key entities:" (comma-separated list)

    template: |-
      -----USER CONTENT START-----
      Post:
      Title: {{ .Title }}
      URL: {{ .URL }}
      Author: {{ .Author }}

      Content:
      {{ .Content }}

      Comments (optional signal; {{ len .Comments }}):
      {{- range $i, $c := .Comments }}
      - {{ $c.Author }}: {{ $c.Content }}
      {{- end }}

      Linked URLs:
      {{- range .WebBlocks }}
      - {{ .URL }}
        {{ .Page }}
      {{- end }}
      -----USER CONTENT END-----

  - id: postSummaryTemplateBatch
    system_template: |-
      You are an expert technical analyst.

      You will be given a list of posts. For each post, write a concise summary focused on the reader interests.
      Keep it factual, and include concrete details (numbers, model names, benchmarks) when present.
      When comments are present, summarise the community response.

      Reader interests:
      {{- range (index .Params "interests") }}
      - {{ . }}
      {{- end }}

      Output format:
      - Return ONLY valid JSON.
      - The top-level value MUST be a JSON array with exactly {{ len .Blocks }} items.
      - Each item MUST be a string summary for the corresponding post (same order as provided).
      - No markdown, no code fences.
    template: |-
      There are {{ len .Blocks }} posts.

      {{- range $i, $p := .Blocks }}
      --- Post {{ $i }} ---
      Title: {{ $p.Title }}
      URL: {{ $p.URL }}
      Author: {{ $p.Author }}

      Content:
      {{ $p.Content }}

      Comments (optional signal; {{ len $p.Comments }}):
      {{- range $c := $p.Comments }}
      - {{ $c.Author }}: {{ $c.Content }}
      {{- end }}

      Linked URLs:
      {{- range $w := $p.WebBlocks }}
      - {{ $w.URL }}
        {{ $w.Page }}
      {{- end }}
      {{- end }}
      
  - id: fullSummaryTemplate
    system_template: |-
      You are writing an aggregate digest across multiple posts.

      Produce an executive summary, then group notable items.

      Include an:
      - Executive summary, focused on 4-8 bullet points
      - Notable Items, pick 5 most relevant items to the focus area, bulleted, include post title + 1 sentence

      Focus areas:
      {{- range (index .Params "focus") }}
      - {{ . }}
      {{- end }}

      Output format:
      # Executive summary
      # Notable items

    template: |-
      There are {{ len .Blocks }} posts.

      Posts:
      {{- range $i, $p := .Blocks }}
      ---
      Title: {{ $p.Title }}
      URL: {{ $p.URL }}
      Author: {{ $p.Author }}
      Post summary (if present): {{- if $p.Summary }}
      {{ $p.Summary.Summary }}
      {{- else }}
      (none)
      {{- end }}
      {{- end }}

  - id: emailTemplate
    system_template: "--" # Email is still considered a prompt template right now
    template: |-
      <!doctype html>
      <html>
        <body style="margin:0;padding:0;background:#ffffff;">
          <div style="max-width:720px;margin:0 auto;padding:16px;font-family:Arial,Helvetica,sans-serif;color:#111;line-height:1.4;">
            <h1 style="margin:0 0 12px 0;font-size:22px;">Daily AI Research Digest</h1>

            {{- if .RunSummary }}
            {{- .RunSummary.HTML }}
            {{- end }}

            <h2 style="margin:16px 0 8px 0;font-size:16px;">Posts ({{ len .Blocks }})</h2>

            {{- range .Blocks }}
            <div style="padding:12px 0;border-top:1px solid #e5e5e5;">
              <div style="font-size:15px;font-weight:700;margin:0 0 4px 0;">
                <a href="{{ .URL }}" style="color:#111;text-decoration:underline;">{{ .Title }}</a>
              </div>
              <div style="font-size:12px;color:#666;margin:0 0 8px 0;">
                <a href="{{ .URL }}" style="color:#666;text-decoration:none;">{{ .URL }}</a>
              </div>
              <div style="font-size:13px;margin:0;">
                {{- if .Summary }}
                {{ .Summary.HTML }}
                {{- else }}
                (no summary)
                {{- end }}
              </div>

              {{- if .WebBlocks }}
              <div style="margin:10px 0 0 0;font-size:13px;">
                <div style="font-weight:700;margin:0 0 4px 0;">Links</div>
                <ul style="margin:0;padding-left:18px;">
                  {{- range .WebBlocks }}
                  <li style="margin:0 0 4px 0;"><a href="{{ .URL }}" style="color:#111;text-decoration:underline;">{{ .URL }}</a></li>
                  {{- end }}
                </ul>
              </div>
              {{- end }}
            </div>
            {{- end }}
          </div>
        </body>
      </html>
